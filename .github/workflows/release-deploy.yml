name: Release & Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci-*'
      - '.github/workflows/infra-*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Step 1: Run tests before release
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run Tests
        run: go test -race -v ./...

      - name: Check Coverage
        run: |
          go test -race -coverprofile=coverage.txt -covermode=atomic ./...
          COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          # TODO: Uncomment when we reach 80% coverage
          # if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          #   echo "âŒ Coverage is below 80%"
          #   exit 1
          # fi

  # Step 2: Semantic Release (creates tag & GitHub release)
  release:
    name: Semantic Release
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Required to push tags and create releases
      issues: write        # Required to comment on issues
      pull-requests: write # Required to comment on PRs
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Output
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "ðŸŽ‰ New release published: v${{ steps.semantic.outputs.new_release_version }}"

  # Step 3: Build & Push Docker Image
  build:
    name: Build & Push
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=v${{ needs.release.outputs.new_release_version }}
            type=semver,pattern=v{{major}}.{{minor}},value=v${{ needs.release.outputs.new_release_version }}
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Step 4: Deploy to Nomad
  deploy:
    name: Deploy to Nomad
    needs: [release, build]
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Nomad via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCE_HOST_PROD_1 }}
          username: ${{ secrets.GCE_USERNAME_PROD_1 }}
          key: ${{ secrets.GCE_SSH_KEY_PROD_1 }}
          script: |
            # Set version for Nomad job
            export VERSION=v${{ needs.release.outputs.new_release_version }}
            
            # Inject GITHUB_TOKEN into Consul KV for Docker auth
            consul kv put railzway-cloud/github_token "${{ secrets.GITHUB_TOKEN }}"
            
            # Submit Nomad job with new version
            nomad job run \
              -var="version=${VERSION}" \
              -var="github_token=${{ secrets.GITHUB_TOKEN }}" \
              /opt/railzway/deployments/railzway-cloud.nomad
            
            # Wait for deployment to be healthy
            echo "Waiting for deployment to stabilize..."
            sleep 15
            
            # Check deployment status
            nomad job status railzway-cloud

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCE_HOST_PROD_1 }}
          username: ${{ secrets.GCE_USERNAME_PROD_1 }}
          key: ${{ secrets.GCE_SSH_KEY_PROD_1 }}
          script: |
            # Wait for service to be ready
            sleep 10

            # Health check via Nomad service
            ALLOC_ID=$(nomad job allocs railzway-cloud | grep running | head -1 | awk '{print $1}')
            
            if [ -z "$ALLOC_ID" ]; then
              echo "âŒ No running allocation found!"
              nomad job status railzway-cloud
              exit 1
            fi
            
            echo "âœ… Allocation $ALLOC_ID is running"
            
            # Get service IP and port from Consul HTTP API
            SERVICE_INFO=$(curl -s http://localhost:8500/v1/health/service/railzway-cloud?passing=true | jq -r '.[0].Service | "\(.Address):\(.Port)"')
            SERVICE_IP=$(echo $SERVICE_INFO | cut -d: -f1)
            SERVICE_PORT=$(echo $SERVICE_INFO | cut -d: -f2)
            
            # Check health endpoint
            if [ -n "$SERVICE_IP" ] && [ -n "$SERVICE_PORT" ] && [ "$SERVICE_IP" != "null" ]; then
              echo "Service discovered at: http://$SERVICE_IP:$SERVICE_PORT"
              if curl -f http://$SERVICE_IP:$SERVICE_PORT/health; then
                echo "âœ… Health check passed! (http://$SERVICE_IP:$SERVICE_PORT/health)"
              else
                echo "âŒ Health check failed!"
                echo "Service: http://$SERVICE_IP:$SERVICE_PORT/health"
                nomad alloc logs $ALLOC_ID server
                exit 1
              fi
            else
              echo "âŒ Could not get service IP from Consul"
              nomad alloc logs $ALLOC_ID server
              exit 1
            fi

      - name: Notify Success
        if: success()
        run: |
          echo "ðŸš€ Successfully deployed v${{ needs.release.outputs.new_release_version }} to Nomad!"


      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"âœ… Deployment Successful\",\"description\":\"**Repository:** \`${{ github.repository }}\`\\n**Version:** \`v${{ needs.release.outputs.new_release_version }}\`\\n**Environment:** Production\",\"color\":3066993,\"fields\":[{\"name\":\"Status\",\"value\":\"Deployed to Nomad\",\"inline\":true},{\"name\":\"Health Check\",\"value\":\"âœ… Passed\",\"inline\":true}],\"footer\":{\"text\":\"Railzway Cloud\"},\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
            $DISCORD_WEBHOOK
