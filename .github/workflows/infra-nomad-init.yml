name: Infra - Provision Nomad Node

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Target Environment
        options: 
          - staging
          - prod
      instance_name:
        description: Name of the VM
        required: true
        default: railzway-nomad-1
      zone:
        description: GCP Zone
        required: true
        default: asia-southeast2-a

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
  WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}

jobs:
  provision:
    name: Create VM
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Instance
        run: |
          gcloud compute instances create ${{ inputs.instance_name }} \
            --project=${{ env.PROJECT_ID }} \
            --zone=${{ inputs.zone }} \
            --machine-type=e2-standard-2 \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --tags=nomad-client,http-server \
            --metadata=startup-script='#! /bin/bash
          
          # Install Docker
          apt-get update
          apt-get install -y docker.io unzip curl
          
          # Install Nomad
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          apt-get update && apt-get install -y nomad
          
          # Configure Nomad (Client Mode)
          cat <<EOF > /etc/nomad.d/nomad.hcl
          data_dir = "/opt/nomad/data"
          bind_addr = "0.0.0.0"
          
          client {
            enabled = true
          }
          EOF
          
          # Enable Service
          systemctl enable nomad
          systemctl start nomad
          '
