name: Infra - Provision Cloud API Node

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Target Environment
        options: 
          - staging
          - prod
      instance_name:
        description: Name of the VM
        required: true
        default: railzway-cloud-api-staging
      zone:
        description: GCP Zone
        required: true
        default: asia-southeast2-a

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
  WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}

jobs:
  provision:
    name: Provision Cloud API VM
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Instance
        run: |
          gcloud compute instances create ${{ inputs.instance_name }} \
            --project=${{ env.PROJECT_ID }} \
            --zone=${{ inputs.zone }} \
            --machine-type=e2-small \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --tags=http-server,https-server \
            --metadata=startup-script='#! /bin/bash
          set -e

          # 1. Install Dependencies
          apt-get update
          apt-get install -y nginx certbot python3-certbot-nginx curl

          # 2. Setup Nginx (Reverse Proxy)
          cat <<EOF > /etc/nginx/sites-available/default
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://localhost:8080;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              }
          }
          EOF
          systemctl restart nginx

          # 3. Setup SystemD Service
          cat <<EOF > /etc/systemd/system/railzway-cloud.service
          [Unit]
          Description=Railzway Cloud API
          After=network.target

          [Service]
          User=root
          ExecStart=/usr/local/bin/railzway-cloud
          Restart=always
          EnvironmentFile=/etc/railzway-cloud.env
          
          # Hardening
          NoNewPrivileges=yes

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create dummy binary/env to prevent failure start loop until first deploy
          touch /etc/railzway-cloud.env
          touch /usr/local/bin/railzway-cloud
          chmod +x /usr/local/bin/railzway-cloud

          systemctl daemon-reload
          systemctl enable railzway-cloud
          '
